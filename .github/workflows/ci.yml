name: ci

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - .github/**
      - .gitignore
  pull_request:
    types: [assigned, opened, synchronize, reopened, labeled]
    paths-ignore:
      - '**.md'
      - .github/**
      - .gitignore

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions: read-all

jobs:
  build-test:
    name: Run build & test
    runs-on: ubuntu-22.04
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
      with:
        egress-policy: audit

    - name: Get github app token
      uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94  # v2.2.0
      id: gh-app-token
      with:
        app-id: ${{ vars.GH_APP_ID }}
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4.5.4

    - name: Prepare pre-requisites
      uses: ./.github/actions/prepare
      with:
        token: ${{ steps.gh-app-token.outputs.token }}

    - name: Style
      run: |
        pnpm style

    - name: Build
      run: |
        pnpm build

    - name: Test
      run: |
        pnpm test
